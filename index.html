<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cinematic Energy System</title>
<style>
body { margin:0; overflow:hidden; background:black; }
video { display:none; }
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/postprocessing/UnrealBloomPass.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>

// ----------------- SCENE -----------------
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.z = 6;

let renderer = new THREE.WebGLRenderer({alpha:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

// Bloom
const composer = new THREE.EffectComposer(renderer);
composer.addPass(new THREE.RenderPass(scene,camera));
const bloom = new THREE.UnrealBloomPass(
  new THREE.Vector2(innerWidth,innerHeight),
  2.5,1.2,0.1
);
composer.addPass(bloom);

// ------------- CORE SPHERE -------------
let coreGeo = new THREE.SphereGeometry(0.7,64,64);
let coreMat = new THREE.MeshBasicMaterial({color:0xaa00ff});
let core = new THREE.Mesh(coreGeo, coreMat);
scene.add(core);

// ------------- ENERGY RING -------------
let ringGeo = new THREE.TorusGeometry(1.2,0.05,16,100);
let ringMat = new THREE.MeshBasicMaterial({color:0xff00ff});
let ring = new THREE.Mesh(ringGeo, ringMat);
ring.rotation.x = Math.PI/2;
scene.add(ring);

// ------------- PARTICLE SYSTEM -------------
let particles = [];

function explosion(x,y){
  for(let i=0;i<500;i++){
    let g = new THREE.SphereGeometry(0.05,6,6);
    let m = new THREE.MeshBasicMaterial({color:0xff00ff});
    let p = new THREE.Mesh(g,m);
    p.position.set(x,y,0);
    p.velocity = new THREE.Vector3(
      (Math.random()-0.5)*0.5,
      (Math.random()-0.5)*0.5,
      (Math.random()-0.5)*0.5
    );
    scene.add(p);
    particles.push(p);
  }
}

// ------------- ANIMATION LOOP -------------
function animate(){
  requestAnimationFrame(animate);

  ring.rotation.z += 0.02;

  particles.forEach((p,i)=>{
    p.position.add(p.velocity);
    p.scale.multiplyScalar(0.96);
    if(p.scale.x < 0.02){
      scene.remove(p);
      particles.splice(i,1);
    }
  });

  composer.render();
}
animate();

// ---------------- HAND TRACKING ----------------
const video = document.getElementById("video");

navigator.mediaDevices.getUserMedia({video:true})
.then(stream=> video.srcObject = stream);

const hands = new Hands({
  locateFile:file =>
  `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

hands.onResults(results=>{
  if(results.multiHandLandmarks.length>0){
    const tip = results.multiHandLandmarks[0][8];
    const thumb = results.multiHandLandmarks[0][4];

    let x = (tip.x-0.5)*10;
    let y = -(tip.y-0.5)*10;

    core.position.set(x,y,0);
    ring.position.set(x,y,0);

    let dist = Math.hypot(tip.x-thumb.x, tip.y-thumb.y);

    // pinch = charge glow
    if(dist < 0.08){
      core.scale.set(1.5,1.5,1.5);
    } else {
      core.scale.set(1,1,1);
    }

    // fist detection (simple heuristic)
    const wrist = results.multiHandLandmarks[0][0];
    if(Math.abs(tip.y - wrist.y) < 0.05){
      explosion(x,y);
    }
  }
});

const cam = new Camera(video,{
  onFrame: async()=>{ await hands.send({image:video}); },
  width:640,
  height:480
});
cam.start();

</script>
</body>
</html>